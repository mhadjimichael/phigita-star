# if you plan to use fastpath, use: ns_server -server [ns_info server] pagedir

proc get_pagedir {} { return /web/data/build/resources }


#ns_log notice "url=$url file=$file url2file=[ns_url2file $url] conn_pool=[ns_conn pool]"
#ns_log notice "ns_config ns/server/[ns_info server]/pool/[ns_conn pool] add_header"


proc serve_static_file {} {

    set url [ns_conn url]
    #ns_return 200 text/html url=$url
    #return

    set filename $url ;# TODO: url2file - check if array exists / otherwise create it yourself
    set file [file normalize [get_pagedir]/${filename}]

    if { ![file isfile $file] || ![file readable $file]} {
	ns_log notice "file=$file not found - return 404" 
	ns_returnnotfound
	return
    }

    set mime [ns_guesstype $file]
    set headers [ns_conn headers]
    set outputheaders [ns_conn outputheaders]
    if {[ns_conn zipaccepted] && [ns_set iget ${headers} Range] eq {}} {
	set gzip_file ${file}.gz
	if { [file readable ${gzip_file}] } {
	    set file ${gzip_file}
	    ns_set put ${outputheaders} Vary Accept-Encoding
	    ns_set put ${outputheaders} Content-Encoding gzip
	}
    }
    ns_returnfile 200 $mime ${file}

}

ns_unregister_op GET /
ns_unregister_op POST /
ns_unregister_op HEAD /

ns_register_proc GET / serve_static_file
ns_register_proc POST / serve_static_file
ns_register_proc HEAD / serve_static_file

#ns_register_proxy
