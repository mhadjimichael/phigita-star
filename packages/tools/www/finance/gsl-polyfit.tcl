source [file dirname [ad_conn file]]/module-gsl-lib.tcl

#define NP 11
#double x[] = {0,  1,  2,  3,  4,  5,  6,   7,   8,   9,   10};
#double y[] = {1,  6,  17, 34, 57, 86, 121, 162, 209, 262, 321};
    
#define DEGREE 3
#double coeff[DEGREE];

#int main()
#{
#    int i;
#    
#    polynomialfit(NP, DEGREE, x, y, coeff);
#    for(i=0; i < DEGREE; i++) {
#			       printf("%lf\n", coeff[i]);
#			   }
#    return 0;
#}

append result "===== gsl_multifit_linear ====="


###

append result "\n\n FIRST EXAMPLE"

set x [iota 11] ;# [list 0 1 2 3 4 5 6 7 8 9 10]
set y [list 1 6 17 34 57 86 121 162 209 262 321]
set NP 11
set DEGREE 3
T_gsl_multifit_linear $NP $DEGREE x y coeff cov

append result "\n x=$x"
append result "\n y=$y"
append result "\n coeff=$coeff"

###

append result "\n\n SECOND EXAMPLE"
set x {1.47 1.50 1.52 1.55 1.57 1.60 1.63 1.65 1.68 1.70 1.73 1.75 1.78 1.80 1.83}
set y {52.21 53.12 54.48 55.84 57.20 58.57 59.93 61.29 63.11 64.47 66.28 68.10 69.92 72.19 74.46}

set NP [llength $x] ;# 15
set DEGREE 3
T_gsl_multifit_linear $NP $DEGREE x y coeff cov


append result "\n x=$x"
append result "\n y=$y"
append result "\n coeff=$coeff"

###

append result "\n\n THIRD EXAMPLE"
set x {-5 -4 -3 -2 -1 0 1 2 3 4 5}
set y { 0  0  0  1  1 1 0 0 0 0 0}

set NP [llength $x]
set DEGREE 11
T_gsl_multifit_linear $NP $DEGREE x y coeff cov


append result "\n x=$x"
append result "\n y=$y"
append result "\n coeff=$coeff"


###

append result "\n\n FOURTH EXAMPLE - FINANCIAL DATA"

set y {105.84 102.41 101.80 103.07 103.22 102.34 103.12 103.85 105.09 105.33 106.50 106.00 106.60 104.44 105.10 105.33 105.43 105.95 105.25 105.01 106.58 108.05 109.03 108.97 108.63 109.10 109.28 108.60 109.66 110.77 111.08 115.86 114.81 116.38 116.17 118.10 116.53 115.62 114.52 110.65 112.04 113.23 111.89 113.89 113.53 112.98 110.73 112.64 112.71 112.05 111.23 109.69 110.90 109.22 109.04 110.00 111.45 113.24 113.44 112.00 114.57 115.37 116.69 118.19 117.88 117.62 115.55 115.80 117.35 116.00 115.95 115.13 114.52 116.63 116.67 116.86 116.78 116.25 116.51 117.30 117.71 117.80 119.03 118.36 116.40 115.69 116.30 117.77 118.30 118.62 118.05 117.81 118.03 119.60 115.78 114.80 112.28 113.37 114.68 112.95 112.81 113.73 114.80 114.12 116.12 113.65 114.59 113.40 113.17 111.08 106.11 100.25 101.45 105.27 103.44 103.60 104.79 102.22 103.42 102.22 104.05 101.97 103.83 107.37 107.50 105.18 105.83 106.63 108.16 109.70 108.86 109.39 106.99 108.47 108.18 105.77 104.53 106.31 107.14 108.84 111.05 111.65 111.56 109.60 110.09 108.10 104.69 104.90 101.13 100.05 97.59 98.31 99.92 97.67 102.93 101.83 101.63 101.10 103.40 101.22 106.10 106.91 104.52 104.98 106.10 105.65 107.11 109.08 107.93 105.02 103.59 102.34 103.27 105.14 106.53 108.42 106.13 106.16 105.00 107.85 106.93 108.07 110.08 114.38 116.46 115.24 113.86 114.23 115.71 115.39 112.52 113.94 114.01 116.49 117.07 115.91 115.23 115.55 118.41 116.94 118.33 119.06 117.97 116.91 115.52 114.57 115.14 116.49 114.81 116.02 115.76 116.31 116.27 116.77 118.78 116.00 117.28 117.17 120.47 123.08 124.40 124.35 123.67 123.60 124.19 123.08 121.69 122.85 120.70 123.61 123.18 122.03 122.82 124.14 124.92 124.06 125.24 126.58 127.52 128.46 127.82 126.49 125.18 123.62 124.70 124.20 127.32 129.54 129.71 129.43 127.36 127.84 127.55 128.47 124.94 125.86 125.94 123.25 123.85 126.15 126.71 125.10 124.16 125.02 122.74 123.46 123.46 124.58 121.13 120.05 118.53 119.27 119.10 119.54 121.50 123.88 120.40 123.18 122.12 121.54 123.20 125.94 126.52 129.89 128.66 130.00 129.52 130.00 128.53 126.25 127.66 128.86 127.98 126.64 127.56 128.87 129.16 129.05 128.81 126.60 125.22 125.80 126.94 126.36 124.59 122.56 122.51 122.99 124.93 122.86 122.50 123.38 124.58 121.73 118.41 118.34 115.00 114.33 117.29 115.04 118.04 119.20 118.97 115.19 116.05 111.47 115.12 118.85 116.21 115.36 116.46 120.11 119.42 114.46 116.96 110.13 104.74 103.44 100.62 95.65 90.55 89.00 87.75 92.21 93.60 88.29 91.52 90.78 92.51 88.86 83.60 84.35 82.07 79.66 87.28 88.20 90.69 92.97 92.68 93.40 89.94 85.15 86.27 83.87 82.74 79.74 84.21 80.33 77.48 80.08 75.97 71.74 74.88 79.89 80.65 81.67 81.60 76.90 79.84 80.67 77.44 80.59 84.86 82.69 82.86 80.58 82.20 82.77 86.40 85.84 84.00 83.52 81.99 80.60 80.52 81.33 81.25 83.55 84.16 87.37 86.82 89.23 87.79 87.18 84.70 85.71 85.34 83.19 84.12 84.92 81.98 91.42 90.07 89.49 91.60 91.66 94.82 92.51 91.65 90.93 93.48 92.83 92.41 96.14 96.82 93.27 95.16 95.07 93.84 90.67 91.51 88.93 88.79 84.37 86.40 85.90 88.97 92.03 89.05 87.77 89.49 87.48 85.81 83.48 87.25 88.62 90.40 90.36 91.22 92.91 91.95 92.66 92.51 98.71 98.30 97.95 98.78 94.15 94.52 96.89 97.61 100.82 102.22 101.56 98.75 101.19 101.70 99.95 99.27 98.85 101.43 101.27 100.43 102.31 102.55 101.42 100.08 99.95 101.94 104.04 103.21 104.61 106.19 105.85 104.62 102.59 101.49 102.90 103.94 102.26 101.05 101.37 104.58 105.51 104.05 102.82 101.89 105.02 102.93 104.69 106.28 108.37 106.83 106.49 106.33 107.24 107.49 108.14 108.35 109.40 108.21 107.62 107.32 107.00 106.33 105.89 104.52 104.44 104.15 106.06 105.68 105.83 104.42 104.84 101.73 101.65 100.19 100.68 102.08 100.83 103.62 103.25 107.22 110.64 115.42 116.44 117.04 115.57 117.06 117.64 117.63 117.28 117.26 117.86 117.93 119.92 119.60 118.47 117.38 119.33 118.70 117.79 119.29 119.58 118.57 116.86 117.63 118.57 118.95 119.90 119.32 118.83 119.47 119.43 118.22 118.05 116.69 116.09 116.33 117.46 117.16 116.76 117.67 118.05 118.88 119.35 121.82 121.88 122.11 121.57 121.61 120.82 120.94 121.08 119.33 118.81 119.61 117.90 119.02 119.75 121.35 122.78 122.29 125.93 127.04 127.02 128.35 127.98 121.64 123.06 122.82 120.87 122.69 120.36 120.11 120.65 121.50 122.87 120.61 120.56 121.16 121.29 123.10 123.49 126.00 126.91 127.19 126.26 127.03 128.21 128.63 128.15 127.54 126.96 128.20 127.93 127.28 125.70 126.35 127.94 127.21 127.55 127.25 127.04 126.80 128.39 129.34 129.68 129.93 128.49 128.71 127.40 127.91 128.65 129.93 130.00 130.57 132.31 131.85 132.57 130.90 132.45 130.85 130.00 129.55 130.85 129.48 130.51 130.23 132.31 131.78 134.14 130.25 129.00 125.50 126.12 125.75 126.33 123.75 122.39 124.67 125.53 125.66 123.00 123.52 121.88 123.21 122.81 123.73 124.00 125.23 126.33 127.81 127.19 126.85 126.46 127.59 127.07 127.16 128.57 127.42 126.88 126.72 127.25 126.41 125.55 125.62 127.60 127.94 127.83 128.67}

#set y [lrange $y end-10 end]
set y [::xo::fun::map yi $y {expr { $yi }}]
set x [iota [llength $y]]
set NP [llength $y]
set DEGREE 4
T_gsl_multifit_linear $NP $DEGREE x y coeff cov


append result "\n x=$x"
append result "\n y=...[lrange $y end-10 end]"
append result "\n coeff=$coeff"

package require math::linearalgebra
namespace import ::math::linearalgebra::*

### provide the observations of the last three days to find the next day forecast, i.e. 1 y_{t-1} y_{t-2} y_{t-3}
lappend forecast [set v0 [matmul [transpose $coeff] [list 1 128.67 127.83 127.94]]]
lappend forecast [set v1 [matmul [transpose $coeff] [list 1 $v0    128.67 127.83]]]
lappend forecast [set v2 [matmul [transpose $coeff] [list 1 $v1    $v0    128.67]]]
lappend forecast [set v2 [matmul [transpose $coeff] [list 1 $v2    $v1    $v0   ]]]

append result "\n NP=$NP"
append result "\n ACTUAL DATA (NEXT DAYS): 127.76 128.38 127.71 127.98 129.37 128.53 129.24 129.26 128.59 128.77 128.25 128.25"
append result "\n FORECAST:\n\t [join $forecast "\n\t"]"



append result "\n\nFIFTH EXAMPLE --- MORE THOUGHT NEEDED HERE"
set y [::xo::fun::map yi $y {expr { log($yi) }}]
set NP [llength $y]
set DEGREE 4
T_gsl_multifit_linear $NP $DEGREE x y coeff cov
set new_X [concat 1 [lreverse [lrange $y end-[expr { $DEGREE - 2}] end]]]
set new_forecast [matmul [transpose $coeff] $new_X]


append result "\n x=$x"
append result "\n y=...[lrange $y end-10 end]"
append result "\n coeff=$coeff"
append result "\n new_forecast ([expr {log(127.76)}]) =$new_forecast"
doc_return 200 text/plain $result
