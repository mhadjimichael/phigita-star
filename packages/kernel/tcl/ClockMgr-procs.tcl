Object ClockMgr
foreach tz {
 :Africa/Abidjan                     :Africa/Accra
 :Africa/Addis_Ababa                 :Africa/Algiers
 :Africa/Asmera                      :Africa/Bamako
 :Africa/Bangui                      :Africa/Banjul
 :Africa/Bissau                      :Africa/Blantyre
 :Africa/Brazzaville                 :Africa/Bujumbura
 :Africa/Cairo                       :Africa/Casablanca
 :Africa/Ceuta                       :Africa/Conakry
 :Africa/Dakar                       :Africa/Dar_es_Salaam
 :Africa/Djibouti                    :Africa/Douala
 :Africa/El_Aaiun                    :Africa/Freetown
 :Africa/Gaborone                    :Africa/Harare
 :Africa/Johannesburg                :Africa/Kampala
 :Africa/Khartoum                    :Africa/Kigali
 :Africa/Kinshasa                    :Africa/Lagos
 :Africa/Libreville                  :Africa/Lome
 :Africa/Luanda                      :Africa/Lubumbashi
 :Africa/Lusaka                      :Africa/Malabo
 :Africa/Maputo                      :Africa/Maseru
 :Africa/Mbabane                     :Africa/Mogadishu
 :Africa/Monrovia                    :Africa/Nairobi
 :Africa/Ndjamena                    :Africa/Niamey
 :Africa/Nouakchott                  :Africa/Ouagadougou
 :Africa/Porto-Novo                  :Africa/Sao_Tome
 :Africa/Timbuktu                    :Africa/Tripoli
 :Africa/Tunis                       :Africa/Windhoek
 :America/Adak                       :America/Anchorage
 :America/Anguilla                   :America/Antigua
 :America/Araguaina                  :America/Argentina/Buenos_Aires
 :America/Argentina/Catamarca        :America/Argentina/ComodRivadavia
 :America/Argentina/Cordoba          :America/Argentina/Jujuy
 :America/Argentina/La_Rioja         :America/Argentina/Mendoza
 :America/Argentina/Rio_Gallegos     :America/Argentina/San_Juan
 :America/Argentina/Tucuman          :America/Argentina/Ushuaia
 :America/Aruba                      :America/Asuncion
 :America/Atka                       :America/Bahia
 :America/Barbados                   :America/Belem
 :America/Belize                     :America/Boa_Vista
 :America/Bogota                     :America/Boise
 :America/Buenos_Aires               :America/Cambridge_Bay
 :America/Campo_Grande               :America/Cancun
 :America/Caracas                    :America/Catamarca
 :America/Cayenne                    :America/Cayman
 :America/Chicago                    :America/Chihuahua
 :America/Coral_Harbour              :America/Cordoba
 :America/Costa_Rica                 :America/Cuiaba
 :America/Curacao                    :America/Danmarkshavn
 :America/Dawson                     :America/Dawson_Creek
 :America/Denver                     :America/Detroit
 :America/Dominica                   :America/Edmonton
 :America/Eirunepe                   :America/El_Salvador
 :America/Ensenada                   :America/Fortaleza
 :America/Fort_Wayne                 :America/Glace_Bay
 :America/Godthab                    :America/Goose_Bay
 :America/Grand_Turk                 :America/Grenada
 :America/Guadeloupe                 :America/Guatemala
 :America/Guayaquil                  :America/Guyana
 :America/Halifax                    :America/Havana
 :America/Hermosillo                 :America/Indiana/Indianapolis
 :America/Indiana/Knox               :America/Indiana/Marengo
 :America/Indiana/Vevay              :America/Indianapolis
 :America/Inuvik                     :America/Iqaluit
 :America/Jamaica                    :America/Jujuy
 :America/Juneau                     :America/Kentucky/Louisville
 :America/Kentucky/Monticello        :America/Knox_IN
 :America/La_Paz                     :America/Lima
 :America/Los_Angeles                :America/Louisville
 :America/Maceio                     :America/Managua
 :America/Manaus                     :America/Martinique
 :America/Mazatlan                   :America/Mendoza
 :America/Menominee                  :America/Merida
 :America/Mexico_City                :America/Miquelon
 :America/Monterrey                  :America/Montevideo
 :America/Montreal                   :America/Montserrat
 :America/Nassau                     :America/New_York
 :America/Nipigon                    :America/Nome
 :America/Noronha                    :America/North_Dakota/Center
 :America/Panama                     :America/Pangnirtung
 :America/Paramaribo                 :America/Phoenix
 :America/Port-au-Prince             :America/Porto_Acre
 :America/Porto_Velho                :America/Port_of_Spain
 :America/Puerto_Rico                :America/Rainy_River
 :America/Rankin_Inlet               :America/Recife
 :America/Regina                     :America/Rio_Branco
 :America/Rosario                    :America/Santiago
 :America/Santo_Domingo              :America/Sao_Paulo
 :America/Scoresbysund               :America/Shiprock
 :America/St_Johns                   :America/St_Kitts
 :America/St_Lucia                   :America/St_Thomas
 :America/St_Vincent                 :America/Swift_Current
 :America/Tegucigalpa                :America/Thule
 :America/Thunder_Bay                :America/Tijuana
 :America/Toronto                    :America/Tortola
 :America/Vancouver                  :America/Virgin
 :America/Whitehorse                 :America/Winnipeg
 :America/Yakutat                    :America/Yellowknife
 :Antarctica/Casey                   :Antarctica/Davis
 :Antarctica/DumontDUrville          :Antarctica/Mawson
 :Antarctica/McMurdo                 :Antarctica/Palmer
 :Antarctica/Rothera                 :Antarctica/South_Pole
 :Antarctica/Syowa                   :Antarctica/Vostok
 :Arctic/Longyearbyen                :Asia/Aden
 :Asia/Almaty                        :Asia/Amman
 :Asia/Anadyr                        :Asia/Aqtau
 :Asia/Aqtobe                        :Asia/Ashgabat
 :Asia/Ashkhabad                     :Asia/Baghdad
 :Asia/Bahrain                       :Asia/Baku
 :Asia/Bangkok                       :Asia/Beirut
 :Asia/Bishkek                       :Asia/Brunei
 :Asia/Calcutta                      :Asia/Choibalsan
 :Asia/Chongqing                     :Asia/Chungking
 :Asia/Colombo                       :Asia/Dacca
 :Asia/Damascus                      :Asia/Dhaka
 :Asia/Dili                          :Asia/Dubai
 :Asia/Dushanbe                      :Asia/Gaza
 :Asia/Harbin                        :Asia/Hong_Kong
 :Asia/Hovd                          :Asia/Irkutsk
 :Asia/Istanbul                      :Asia/Jakarta
 :Asia/Jayapura                      :Asia/Jerusalem
 :Asia/Kabul                         :Asia/Kamchatka
 :Asia/Karachi                       :Asia/Kashgar
 :Asia/Katmandu                      :Asia/Krasnoyarsk
 :Asia/Kuala_Lumpur                  :Asia/Kuching
 :Asia/Kuwait                        :Asia/Macao
 :Asia/Macau                         :Asia/Magadan
 :Asia/Makassar                      :Asia/Manila
 :Asia/Muscat                        :Asia/Nicosia
 :Asia/Novosibirsk                   :Asia/Omsk
 :Asia/Oral                          :Asia/Phnom_Penh
 :Asia/Pontianak                     :Asia/Pyongyang
 :Asia/Qatar                         :Asia/Qyzylorda
 :Asia/Rangoon                       :Asia/Riyadh
 :Asia/Saigon                        :Asia/Sakhalin
 :Asia/Samarkand                     :Asia/Seoul
 :Asia/Shanghai                      :Asia/Singapore
 :Asia/Taipei                        :Asia/Tashkent
 :Asia/Tbilisi                       :Asia/Tehran
 :Asia/Tel_Aviv                      :Asia/Thimbu
 :Asia/Thimphu                       :Asia/Tokyo
 :Asia/Ujung_Pandang                 :Asia/Ulaanbaatar
 :Asia/Ulan_Bator                    :Asia/Urumqi
 :Asia/Vientiane                     :Asia/Vladivostok
 :Asia/Yakutsk                       :Asia/Yekaterinburg
 :Asia/Yerevan                       :Atlantic/Azores
 :Atlantic/Bermuda                   :Atlantic/Canary
 :Atlantic/Cape_Verde                :Atlantic/Faeroe
 :Atlantic/Jan_Mayen                 :Atlantic/Madeira
 :Atlantic/Reykjavik                 :Atlantic/South_Georgia
 :Atlantic/Stanley                   :Atlantic/St_Helena
 :Australia/ACT                      :Australia/Adelaide
 :Australia/Brisbane                 :Australia/Broken_Hill
 :Australia/Canberra                 :Australia/Currie
 :Australia/Darwin                   :Australia/Hobart
 :Australia/LHI                      :Australia/Lindeman
 :Australia/Lord_Howe                :Australia/Melbourne
 :Australia/North                    :Australia/NSW
 :Australia/Perth                    :Australia/Queensland
 :Australia/South                    :Australia/Sydney
 :Australia/Tasmania                 :Australia/Victoria
 :Australia/West                     :Australia/Yancowinna
 :Brazil/Acre                        :Brazil/DeNoronha
 :Brazil/East                        :Brazil/West
 :Canada/Atlantic                    :Canada/Central
 :Canada/East-Saskatchewan           :Canada/Eastern
 :Canada/Mountain                    :Canada/Newfoundland
 :Canada/Pacific                     :Canada/Saskatchewan
 :Canada/Yukon                       :CET
 :Chile/Continental                  :Chile/EasterIsland
 :CST6CDT                            :Cuba
 :EET                                :Egypt
 :Eire                               :EST
 :EST5EDT                            :Etc/GMT
 :Etc/GMT+0                          :Etc/GMT+1
 :Etc/GMT+10                         :Etc/GMT+11
 :Etc/GMT+12                         :Etc/GMT+2
 :Etc/GMT+3                          :Etc/GMT+4
 :Etc/GMT+5                          :Etc/GMT+6
 :Etc/GMT+7                          :Etc/GMT+8
 :Etc/GMT+9                          :Etc/GMT-0
 :Etc/GMT-1                          :Etc/GMT-10
 :Etc/GMT-11                         :Etc/GMT-12
 :Etc/GMT-13                         :Etc/GMT-14
 :Etc/GMT-2                          :Etc/GMT-3
 :Etc/GMT-4                          :Etc/GMT-5
 :Etc/GMT-6                          :Etc/GMT-7
 :Etc/GMT-8                          :Etc/GMT-9
 :Etc/GMT0                           :Etc/Greenwich
 :Etc/UCT                            :Etc/Universal
 :Etc/UTC                            :Etc/Zulu
 :Europe/Amsterdam                   :Europe/Andorra
 :Europe/Athens                      :Europe/Belfast
 :Europe/Belgrade                    :Europe/Berlin
 :Europe/Bratislava                  :Europe/Brussels
 :Europe/Bucharest                   :Europe/Budapest
 :Europe/Chisinau                    :Europe/Copenhagen
 :Europe/Dublin                      :Europe/Gibraltar
 :Europe/Helsinki                    :Europe/Istanbul
 :Europe/Kaliningrad                 :Europe/Kiev
 :Europe/Lisbon                      :Europe/Ljubljana
 :Europe/London                      :Europe/Luxembourg
 :Europe/Madrid                      :Europe/Malta
 :Europe/Mariehamn                   :Europe/Minsk
 :Europe/Monaco                      :Europe/Moscow
 :Europe/Nicosia                     :Europe/Oslo
 :Europe/Paris                       :Europe/Prague
 :Europe/Riga                        :Europe/Rome
 :Europe/Samara                      :Europe/San_Marino
 :Europe/Sarajevo                    :Europe/Simferopol
 :Europe/Skopje                      :Europe/Sofia
 :Europe/Stockholm                   :Europe/Tallinn
 :Europe/Tirane                      :Europe/Tiraspol
 :Europe/Uzhgorod                    :Europe/Vaduz
 :Europe/Vatican                     :Europe/Vienna
 :Europe/Vilnius                     :Europe/Warsaw
 :Europe/Zagreb                      :Europe/Zaporozhye
 :Europe/Zurich                      :GB
 :GB-Eire                            :GMT
 
} {

    ClockMgr set TZData([string tolower ${tz}]) $tz

}


ClockMgr array set UL_REGION_TO_TZ {
    US/AL	America/Chicago 
    US/AK	America/Anchorage 
    US/AZ	America/Phoenix 
    US/AR America/Chicago 
    US/CA	America/Los_Angeles 
    US/CO	America/Denver 
    US/CT	America/New_York 
    US/DE	America/New_York
    US/DC	America/New_York 
    US/FL	America/New_York 
    US/GA	America/New_York 
    US/HI	Pacific/Honolulu 
    US/ID	America/Denver 
    US/IL	America/Chicago
    US/IN	America/Indianapolis 
    US/IA	America/Chicago 
    US/KS	America/Chicago 
    US/KY	America/New_York 
    US/LA	America/Chicago 
    US/ME	America/New_York 
    US/MD	America/New_York
    US/MA	America/New_York
    US/MI	America/New_York 
    US/MN	America/Chicago 
    US/MS	America/Chicago 
    US/MO	America/Chicago 
    US/MT	America/Denver 
    US/NE	America/Chicago 
    US/NV	America/Los_Angeles 
    US/NH	America/New_York 
    US/NJ	America/New_York 
    US/NM	America/Denver 
    US/NY	America/New_York
    US/NC	America/New_York
    US/ND	America/Chicago
    US/OH	America/New_York 
    US/OK	America/Chicago 
    US/OR	America/Los_Angeles 
    US/PA	America/New_York  
    US/RI	America/New_York 
    US/SC	America/New_York 
    US/SD	America/Chicago 
    US/TN	America/Chicago 
    US/TX	America/Chicago 
    US/UT	America/Denver 
    US/VT	America/New_York 
    US/VA	America/New_York 
    US/WA	America/Los_Angeles 
    US/WV	America/New_York 
    US/WI	America/Chicago 
    CA/AB	America/Edmonton 
    CA/BC	America/Vancouver 
    CA/MB	America/Winnipeg 
    CA/NB	America/Halifax 
    CA/NF	America/St_Johns 
    CA/NT	America/Yellowknife 
    CA/NS	America/Halifax 
    CA/NU	America/Rankin_Inlet 
    CA/ON	America/Rainy_River 
    CA/PE	America/Halifax 
    CA/QC	America/Montreal 
    CA/SK	America/Regina 
    AS    US/Samoa 
    CI    Africa/Abidjan 
    GH    Africa/Accra
    DZ    Africa/Algiers
    ER    Africa/Asmera
    ML    Africa/Bamako
    CF    Africa/Bangui
    GM    Africa/Banjul
    GW    Africa/Bissau
    CG    Africa/Brazzaville
    BI    Africa/Bujumbura
    EG    Africa/Cairo
    MA    Africa/Casablanca
    GN    Africa/Conakry
    SN    Africa/Dakar
    DJ    Africa/Djibouti
    SL    Africa/Freetown
    BW    Africa/Gaborone
    ZW    Africa/Harare
    ZA    Africa/Johannesburg
    UG    Africa/Kampala
    SD    Africa/Khartoum
    RW    Africa/Kigali
    NG    Africa/Lagos
    GA    Africa/Libreville
    TG    Africa/Lome
    AO    Africa/Luanda
    ZM    Africa/Lusaka
    GQ    Africa/Malabo
    MZ    Africa/Maputo
    LS    Africa/Maseru
    SZ    Africa/Mbabane
    SO    Africa/Mogadishu
    LR    Africa/Monrovia
    KE    Africa/Nairobi
    TD    Africa/Ndjamena
    NE    Africa/Niamey
    MR    Africa/Nouakchott
    BF    Africa/Ouagadougou
    ST    Africa/Sao_Tome
    LY    Africa/Tripoli
    TN    Africa/Tunis
    AI    America/Anguilla
    AG    America/Antigua
    AW    America/Aruba
    BB    America/Barbados
    BZ    America/Belize
    CO    America/Bogota
    VE    America/Caracas
    KY    America/Cayman
    MX    America/Chihuahua
    CR    America/Costa_Rica
    DM    America/Dominica
    SV    America/El_Salvador
    GD    America/Grenada
    FR    Europe/Paris
    GP    America/Guadeloupe
    GT    America/Guatemala
    EC    America/Guayaquil
    GY    America/Guyana
    CU    America/Havana
    JM    America/Jamaica
    BO    America/La_Paz
    PE    America/Lima
    NI    America/Managua
    MQ    America/Martinique
    AR    America/Mendoza
    UY    America/Montevideo
    MS    America/Montserrat
    BS    America/Nassau
    PA    America/Panama
    SR    America/Paramaribo
    PR    America/Puerto_Rico
    KN    America/St_Kitts
    LC    America/St_Lucia
    VC    America/St_Vincent
    HN    America/Tegucigalpa
    YE    Asia/Aden
    KZ    Asia/Almaty
    JO    Asia/Amman
    TM    Asia/Ashgabat
    IQ    Asia/Baghdad
    BH    Asia/Bahrain
    AZ    Asia/Baku
    TH    Asia/Bangkok
    LB    Asia/Beirut
    KG    Asia/Bishkek
    BN    Asia/Brunei
    IN    Asia/Calcutta
    MN    Asia/Choibalsan
    CN    Asia/Chongqing
    LK    Asia/Colombo
    BD    Asia/Dhaka
    AE    Asia/Dubai
    TJ    Asia/Dushanbe
    HK    Asia/Hong_Kong
    TR    Asia/Istanbul
    ID    Asia/Jakarta
    IL    Asia/Jerusalem
    AF    Asia/Kabul
    PK    Asia/Karachi
    NP    Asia/Katmandu
    KW    Asia/Kuwait
    MO    Asia/Macao
    PH    Asia/Manila
    OM    Asia/Muscat
    CY    Asia/Nicosia
    KP    Asia/Pyongyang
    QA    Asia/Qatar
    MM    Asia/Rangoon
    SA    Asia/Riyadh
    KR    Asia/Seoul
    SG    Asia/Singapore
    TW    Asia/Taipei
    UZ    Asia/Tashkent
    GE    Asia/Tbilisi
    BT    Asia/Thimphu
    JP    Asia/Tokyo
    LA    Asia/Vientiane
    AM    Asia/Yerevan
    PT    Atlantic/Azores
    BM    Atlantic/Bermuda
    CV    Atlantic/Cape_Verde
    FO    Atlantic/Faeroe
    IS    Atlantic/Reykjavik
    GS    Atlantic/South_Georgia
    SH    Atlantic/St_Helena
    AU    Australia/Queensland
    BR    Brazil/Acre
    CL    Chile/Continental
    NL    Europe/Amsterdam
    AD    Europe/Andorra
    GR    Europe/Athens
    YU   Europe/Belgrade
    DE    Europe/Berlin
    SK    Europe/Bratislava
    BE    Europe/Brussels
    RO    Europe/Bucharest
    HU    Europe/Budapest
    DK    Europe/Copenhagen
    IE    Europe/Dublin
    GI    Europe/Gibraltar
    FI    Europe/Helsinki
    UA    Europe/Kiev
    SI    Europe/Ljubljana
    GB    Europe/London
    LU    Europe/Luxembourg
    ES    Europe/Madrid
    MT    Europe/Malta
    BY    Europe/Minsk
    MC    Europe/Monaco
    RU    Europe/Moscow
    NO    Europe/Oslo
    CZ    Europe/Prague
    LV    Europe/Riga
    IT    Europe/Rome
    SM    Europe/San_Marino
    BA    Europe/Sarajevo
    MK    Europe/Skopje
    BG    Europe/Sofia
    SE    Europe/Stockholm
    EE    Europe/Tallinn
    AL    Europe/Tirane
    LI    Europe/Vaduz
    VA    Europe/Vatican
    AT    Europe/Vienna
    LT    Europe/Vilnius
    PL    Europe/Warsaw
    HR    Europe/Zagreb
    IR    Asia/Tehran
    NZ    Pacific/Auckland
    MG    Indian/Antananarivo
    CX    Indian/Christmas
    CC    Indian/Cocos
    KM    Indian/Comoro
    MV    Indian/Maldives
    MU    Indian/Mauritius
    YT    Indian/Mayotte
    RE    Indian/Reunion
    FJ    Pacific/Fiji
    TV    Pacific/Funafuti
    GU   Pacific/Guam
    NR    Pacific/Nauru
    NU    Pacific/Niue
    NF    Pacific/Norfolk
    PW    Pacific/Palau
    PN    Pacific/Pitcairn
    CK    Pacific/Rarotonga
    WS    Pacific/Samoa
    KI    Pacific/Tarawa
    TO    Pacific/Tongatapu
    WF    Pacific/Wallis
    TZ    Africa/Dar_es_Salaam
    VN    Asia/Phnom_Penh
    KH    Asia/Phnom_Penh
    CM    Africa/Lagos
    DO   America/Santo_Domingo
    TL    Asia/Jakarta
    ET    Africa/Addis_Ababa
    FX    Europe/Paris
    GL    America/Godthab
    HT    America/Port-au-Prince
    CH    Europe/Zurich
}	    


ClockMgr proc glob {pattern} {
    set tz [lindex [ClockMgr array names TZData -glob $pattern] 0]
    if { $tz ne {} } {
	return [ClockMgr set TZData($tz)]
    } else {
	return
    }
}

ClockMgr proc getTime {tz} {
    return [clock format [clock seconds] -format "%l:%M%P (%Z)" -timezone $tz]
}

ClockMgr proc getLocalTime {{-format "%a %b %d %H:%M:%S %Z %Y"}} {
    set tz [my getLocalTZ]
    return [clock format [clock seconds] -format ${format} -timezone :${tz}]
}



ClockMgr proc getTimeIn {{-regionCodeVar ""} {-format "%a %b %d %H:%M:%S %Z %Y"} country region} {
    if { $regionCodeVar ne {} } {
	upvar $regionCodeVar regionCode
    }
    set regionCode [my getValidRegion $country/$region $country ""]
    if { $regionCode ne {} } {
	my instvar UL_REGION_TO_TZ
	set tz $UL_REGION_TO_TZ($regionCode)
	return [clock format [clock seconds] -format ${format} -timezone :${tz}]
    } else {
	return ""
    }
}


ClockMgr proc getLocalRegion {} {
    return [my getValidRegion [ad_conn UL_REGION] [ad_conn UL_CC] "CY"]
}
ClockMgr proc getValidRegion {args} {
    my instvar UL_REGION_TO_TZ
    foreach region ${args} {
	if { [info exists UL_REGION_TO_TZ(${region})] } {
	    break;
	}
    }
    return $region
}

ClockMgr proc getLocalTZ {} {
    my instvar UL_REGION_TO_TZ
    return $UL_REGION_TO_TZ([my getLocalRegion])
}

ClockMgr proc localize {dt} {
    set tz [my getLocalTZ]
    set result $dt
    catch {
	ns_log notice dt=$dt
	ns_log notice ndt=[clock scan $dt]
	set result [clock format [clock scan $dt] -format "%Y-%m-%d %H:%M:%S" -timezone :$tz]
    }
    return $result
}