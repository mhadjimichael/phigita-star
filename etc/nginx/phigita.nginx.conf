user nsadmin web;

worker_processes 5;

error_log /var/log/nginx/error_log error;

events {
	worker_connections  8192;
	#worker_connections  10240;
	# use [ kqueue | rtsig | epoll | /dev/poll | select | poll ];
	use epoll;

}

http {
	include		/etc/nginx/mime.types;
	default_type	application/octet-stream;

	log_format main
		'$remote_addr - $remote_user [$time_local] '
        	'"$request" $status $bytes_sent '
		'"$http_referer" "$http_user_agent" '
		'"$gzip_ratio"';


	error_log /var/log/nginx/error_log error;
	access_log off;

	# for security reasons, hide server version in the server header
	server_tokens off;
									       
	client_header_timeout	10m;
	client_body_timeout	10m;
	send_timeout		10m;

	connection_pool_size		256;
	client_header_buffer_size	1k;
	large_client_header_buffers	4 4k;
	request_pool_size		4k;

	gzip on;
	gzip_proxied any;
	gzip_http_version 1.0;
	gzip_comp_level 4;
	gzip_min_length	1100;
	gzip_buffers	4 8k;
	gzip_types	text/plain text/html text/css application/x-javascript text/xml application/xml application/xml+rss text/javascript;

	output_buffers	1 32k;
	postpone_output	1460;

	sendfile	on;
	tcp_nopush	on;
	tcp_nodelay	off;



	#keepalive_timeout	75 20;
	#keepalive_timeout	32 20;
	keepalive_timeout	10 5;


        #lingering_time     30;
        #lingering_timeout  10;
        #reset_timedout_connection  on;


	server_names_hash_bucket_size	512;


	ignore_invalid_headers	on;

	index index.html;

	## Proxy options
  	#proxy_buffering           on;
	#proxy_cache_min_uses       3;
  	#proxy_cache_path          /usr/local/nginx/proxy_temp/ levels=1:2 keys_zone=cache:10m inactive=10m max_size=1000M;
  	#proxy_cache_valid         any 10m;
  	#proxy_ignore_client_abort off;
  	#proxy_intercept_errors    on;
  	proxy_next_upstream       error timeout invalid_header;
  	#proxy_redirect            off;
  	#proxy_set_header          X-Forwarded-For $remote_addr;
  	#proxy_connect_timeout     60;
  	#proxy_send_timeout        60;
  	#proxy_read_timeout        60;




	upstream main_phigita_net {
                server 127.0.0.1:8001;
                server 127.0.0.1:8000 backup;
        }

	upstream books_phigita_net {
		server 127.0.0.1:8001;
                server 127.0.0.1:8000 backup;
	}



	upstream my_phigita_net {
                server 127.0.0.1:8001;
                server 127.0.0.1:8000 backup;
        }


	server {
		listen	80;
		server_name *.greek-class.com *.greek-class.net *.greek-class.org *.squanti.net *.squanti.info *.cyprusdb.biz *.cyprusdb.net *.cyprusdb.info *.phigita.biz *.telequa.com;
		location / {
		        rewrite (.*) /404.html break;
			root /web/data/error-pages/;
		}
	}


	server {
		listen	443;
		server_name *.greek-class.com *.greek-class.net *.greek-class.org *.squanti.net *.squanti.info *.cyprusdb.biz *.cyprusdb.net *.cyprusdb.info *.phigita.biz *.phigita.com;


	        ssl                  on;
	        ssl_certificate      /web/data/ssl/nginx.cert;
	        ssl_certificate_key  /web/data/ssl/nginx.key;
	        keepalive_timeout    10 5;


		location / {
		        rewrite (.*) /404.html break;
			root /web/data/error-pages/;
		}
	}

	server {
		listen	443;
		server_name echo.phigita.net;

		rewrite        ^ http://$server_name$request_uri? break;
	}
	server {
		listen	443;
		server_name answers.phigita.net;

		rewrite        ^ http://$server_name$request_uri? break;
	}
	server {
		listen	443;
		server_name blogs.phigita.net;

		rewrite        ^ http://$server_name$request_uri? break;
	}
	server {
		listen	443;
		server_name remarks.phigita.net;

		rewrite        ^ http://$server_name$request_uri? break;
	}




	# Static - Graphics - NOSSL
	server {
		listen	80;
		server_name g00.phigita.net g01.phigita.net;
	        keepalive_timeout    10 5;
		location / {
		    root	/web/data/resources/images/;
		    expires max;
		}
	}
	# Static - Graphics - SSL
	server {
		listen	443;
		server_name g10.phigita.net g11.phigita.net;
	        ssl                  on;
	        ssl_certificate      /web/data/ssl/nginx.cert;
	        ssl_certificate_key  /web/data/ssl/nginx.key;
	        keepalive_timeout    10 5;
		location / {
		    root	/web/data/resources/images/;
		    expires max;
		}
		
	}

	# Static - Buzz Images - NOSSL
	server {
		listen	80;
		server_name img.phigita.net i00-buzz.phigita.net i01-buzz.phigita.net;
	        keepalive_timeout    10 5;
		location / {
		    rewrite 	^/(..)(.*)$  /$1/$1$2-sample-80x80.jpg  break;
		    root	/web/data/news/images/;
		    expires max;
		    add_header	Cache-Control "public";
		}

	}
	# Static - Book Covers - NOSSL
	server {
		listen	80;
		server_name i00-books.phigita.net i01-books.phigita.net;
	        keepalive_timeout    10 5;
		location / {
		    root	/web/data/books/cover/;
		    expires max;
		    add_header	Cache-Control "public";
		}
	}




	server {
		listen		80;
		server_name	my.phigita.net;

		gzip off;
		access_log	off;
		root /web/service-phgt-0/;

		location /im/ {

		    access_log off;

	            proxy_pass         http://my_phigita_net;
	            proxy_redirect     off;
		    proxy_buffering    off;
                    proxy_ignore_client_abort off;
		    proxy_store off;

        	    proxy_set_header   Host             $host;
	            proxy_set_header   X-Real-IP        $remote_addr;
	            proxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for;
	            proxy_set_header   X-Forwarded-Proto $scheme;

		    proxy_hide_header MIME-Version;

		    keepalive_timeout	0;
	            client_max_body_size       50m;
	            client_body_buffer_size    128k;

		    msie_padding off;
		    postpone_output 0;


		    tcp_nodelay on;

		    gzip off;
		    gzip_proxied off;

	            proxy_connect_timeout      30;
	            proxy_send_timeout         30;
	            proxy_read_timeout         300;


		    add_header	Cache-Control "no-cache,must-revalidate";
		    add_header	Pragma "no-cache";
		    add_header  Expires "-1";
		}


	        location / {
	            proxy_pass         http://my_phigita_net;
	            proxy_redirect     off;

		    proxy_intercept_errors on;

        	    proxy_set_header   Host             $host;
	            proxy_set_header   X-Real-IP        $remote_addr;
	            proxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for;
	            proxy_set_header   X-Forwarded-Proto $scheme;

		    proxy_hide_header MIME-Version;

	            client_max_body_size       100m;
	            client_body_buffer_size    128k;
		    client_body_timeout	       30m;


	            proxy_connect_timeout      30;
	            proxy_send_timeout         180;
	            proxy_read_timeout         180;

		    proxy_buffering 		on;
	            proxy_buffer_size          32k;
	            proxy_buffers              4 32k;
	            proxy_busy_buffers_size    64k;
	            proxy_temp_file_write_size 64k;
		    #proxy_max_temp_file_size 0;


		    add_header	Cache-Control "nocache,must-revalidate";
		    add_header	Pragma "no-cache";
		    add_header  Expires "-1";
	        }



		error_page 404 /404.html;
		location = /404.html {
			# This means, that we can't get to this location from outside - only by internal redirect
			internal;
	                root  /web/data/error-pages/;
		}

		error_page   502 503 504  /50x.html;
		location = /50x.html {
			# This means, that we can't get to this location from outside - only by internal redirect
			internal;
	                root  /web/data/error-pages/;
		}

		location /lib/data/ {
		    rewrite 	^/lib/data/(.*)$  /$1  break;
		    root	/web/data/js/;
		    expires 90d;
		}
		location /resources/ {
		    rewrite 	^/resources/(.*)$  /$1  break;
		    root	/web/data/resources/;
		    expires max;
		}
		location /graphics/ {
		    rewrite 	^/graphics/(.*)$  /$1  break;
		    root	/web/data/graphics/;
		    expires max;
		    add_header	Cache-Control "public";
		}
		location /favicon.ico {
		    root	/web/data/graphics/;
		    expires max;
		}

	}

	server {
		listen		443;
		server_name	my.phigita.net;

	        ssl                  on;
	        ssl_certificate      /web/data/ssl/nginx.cert;
	        ssl_certificate_key  /web/data/ssl/nginx.key;
	        keepalive_timeout    10 5;


		access_log	off;
	#/var/log/nginx/my_phigita_net-access.log main;

		root /web/service-phgt-0/;

		location /im/ {

		    access_log off;
		    expires 0d;

	            proxy_pass         http://my_phigita_net;
	            proxy_redirect     off;
		    proxy_buffering    off;
                    proxy_ignore_client_abort off;
		    proxy_store off;

        	    proxy_set_header   Host             $host;
	            proxy_set_header   X-Real-IP        $remote_addr;
	            proxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for;
	            proxy_set_header   X-Forwarded-Proto $scheme;

		    proxy_hide_header MIME-Version;

		    keepalive_timeout	0;
	            client_max_body_size       50m;
	            client_body_buffer_size    128k;

		    msie_padding off;
		    postpone_output 0;


		    sendfile on;
		    tcp_nopush on;
		    tcp_nodelay off;

		    gzip off;
		    gzip_proxied off;

	            proxy_connect_timeout      30;
	            proxy_send_timeout         30;
	            proxy_read_timeout         300;


		}


	        location / {
	            proxy_pass         http://my_phigita_net;
	            proxy_redirect     off;

		    proxy_intercept_errors on;

        	    proxy_set_header   Host             $host;
	            proxy_set_header   X-Real-IP        $remote_addr;
	            proxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for;
	            proxy_set_header   X-Forwarded-Proto $scheme;

		    proxy_hide_header MIME-Version;

	            client_max_body_size       50m;
	            client_body_buffer_size    128k;

	            proxy_connect_timeout      30;
	            proxy_send_timeout         180;
	            proxy_read_timeout         180;

		    proxy_buffering 		on;
	            proxy_buffer_size          32k;
	            proxy_buffers              4 32k;
	            proxy_busy_buffers_size    64k;
	            proxy_temp_file_write_size 64k;
	        }



		error_page 404 /404.html;
		location = /404.html {
			# This means, that we can't get to this location from outside - only by internal redirect
			internal;
	                root  /web/data/error-pages/;
		}

		error_page   502 503 504  /50x.html;
		location = /50x.html {
			# This means, that we can't get to this location from outside - only by internal redirect
			internal;
	                root  /web/data/error-pages/;
		}

		location /lib/data/ {
		    rewrite 	^/lib/data/(.*)$  /$1  break;
		    root	/web/data/js/;
		    expires 90d;
		}
		location /resources/ {
		    rewrite 	^/resources/(.*)$  /$1  break;
		    root	/web/data/resources/;
		    expires max;
		}
		location /graphics/ {
		    rewrite 	^/graphics/(.*)$  /$1  break;
		    root	/web/data/graphics/;
		    expires max;
		    add_header	Cache-Control "public";
		}
		location /favicon.ico {
		    root	/web/data/graphics/;
		    expires max;
		}


	}

	server {
		listen		80;
		server_name	www.phigita.net phigita.net echo.phigita.net video.phigita.net answers.phigita.net blogs.phigita.net remarks.phigita.net api.phigita.net;
#(echo|mms|news|buzz|books|answers|blogs|remarks|maps|events).phigita.net;

		gzip off;
		access_log off;
		root /web/service-phgt-0/;

	        location / {
	            proxy_pass         http://main_phigita_net;
	            proxy_redirect     off;
		    proxy_intercept_errors on;

        	    proxy_set_header   Host             $host;
	            proxy_set_header   X-Real-IP        $remote_addr;
	            proxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for;
	            proxy_set_header   X-Forwarded-Proto $scheme;

		    proxy_hide_header MIME-Version;

	            client_max_body_size       10m;
	            client_body_buffer_size    128k;

	            proxy_connect_timeout      30;
	            proxy_send_timeout         30;
	            proxy_read_timeout         30;

		    proxy_buffering 		on;
	            proxy_buffer_size          32k;
	            proxy_buffers              4 32k;
	            proxy_busy_buffers_size    64k;
	            proxy_temp_file_write_size 64k;

		    add_header	Cache-Control "no-cache,must-revalidate";
		    add_header	Pragma "no-cache";
		    add_header  Expires "-1";

	        }


		error_page 404 /404.html;
		location = /404.html {
			# This means, that we can't get to this location from outside - only by internal redirect
			internal;
	                root  /web/data/error-pages/;
		}

		error_page   502 503 504  /50x.html;
		location = /50x.html {
			# This means, that we can't get to this location from outside - only by internal redirect
			internal;
	                root  /web/data/error-pages/;
		}

		location /lib/data/ {
		    rewrite 	^/lib/data/(.*)$  /$1  break;
		    root	/web/data/js/;
		    expires 90d;
		}
		location /resources/ {
		    rewrite 	^/resources/(.*)$  /$1  break;
		    root	/web/data/resources/;
		    expires max;
		}

		location /graphics/ {
		    rewrite 	^/graphics/(.*)$  /$1  break;
		    root	/web/data/graphics/;
		    expires max;
		    add_header	Cache-Control "public";
		}
		location /favicon.ico {
		    root	/web/data/graphics/;
		    expires max;
		}


	}



	server {
		listen		80;
		server_name	books.phigita.net;



		access_log off;
		root /web/service-phgt-0/;

	        location / {
	            proxy_pass         http://books_phigita_net;
	            proxy_redirect     off;
		    proxy_intercept_errors on;

        	    proxy_set_header   Host             $host;
	            proxy_set_header   X-Real-IP        $remote_addr;
	            proxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for;
	            proxy_set_header   X-Forwarded-Proto $scheme;

		    proxy_hide_header MIME-Version;

	            client_max_body_size       10m;
	            client_body_buffer_size    128k;

	            proxy_connect_timeout      30;
	            proxy_send_timeout         30;
	            proxy_read_timeout         30;

		    proxy_buffering 		on;
	            proxy_buffer_size          32k;
	            proxy_buffers              4 32k;
	            proxy_busy_buffers_size    64k;
	            proxy_temp_file_write_size 64k;
	        }


		error_page 404 /404.html;
		location = /404.html {
			# This means, that we can't get to this location from outside - only by internal redirect
			internal;
	                root  /web/data/error-pages/;
		}

		error_page   502 503 504  /50x.html;
		location = /50x.html {
			# This means, that we can't get to this location from outside - only by internal redirect
			internal;
	                root  /web/data/error-pages/;
		}

		location /lib/data/ {
		    rewrite 	^/lib/data/(.*)$  /$1  break;
		    root	/web/data/js/;
		    expires 90d;
		}
		location /resources/ {
		    rewrite 	^/resources/(.*)$  /$1  break;
		    root	/web/data/resources/;
		    expires max;
		}

		location /graphics/ {
		    rewrite 	^/graphics/(.*)$  /$1  break;
		    root	/web/data/graphics/;
		    expires max;
		    add_header	Cache-Control "public";
		}
		location /favicon.ico {
		    root	/web/data/graphics/;
		    expires max;
		}


	}





	server {
		listen 80;
		server_name buzz.phigita.net;
		rewrite ^.*$ http://blogs.sync.gr/ permanent;
	}

	server {
		listen		80;
		server_name	maps.phigita.net;
		rewrite ^.*$ http://www.openstreetmap.com/ permanent;		
	}

	server {
		listen		443;
		server_name	www.phigita.net phigita.net;
# echo.phigita.net answers.phigita.net blogs.phigita.net remarks.phigita.net;
#(echo|mms|news|buzz|books|answers|blogs|remarks|maps|events).phigita.net;


	        ssl                  on;
	        ssl_certificate      /web/data/ssl/nginx.cert;
	        ssl_certificate_key  /web/data/ssl/nginx.key;
	        keepalive_timeout    10 5;


		access_log off;
		root /web/service-phgt-0/;

	        location /accounts/ {
	            proxy_pass         http://main_phigita_net;
	            proxy_redirect     off;
		    proxy_intercept_errors on;

        	    proxy_set_header   Host             $host;
	            proxy_set_header   X-Real-IP        $remote_addr;
	            proxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for;
	            proxy_set_header   X-Forwarded-Proto $scheme;

		    proxy_hide_header MIME-Version;

	            client_max_body_size       10m;
	            client_body_buffer_size    128k;

	            proxy_connect_timeout      30;
	            proxy_send_timeout         30;
	            proxy_read_timeout         30;

		    proxy_buffering 		on;
	            proxy_buffer_size          32k;
	            proxy_buffers              4 32k;
	            proxy_busy_buffers_size    64k;
	            proxy_temp_file_write_size 64k;
	        }

	        location /admin/ {
	            proxy_pass         http://main_phigita_net;
	            proxy_redirect     off;
		    proxy_intercept_errors on;

        	    proxy_set_header   Host             $host;
	            proxy_set_header   X-Real-IP        $remote_addr;
	            proxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for;
	            proxy_set_header   X-Forwarded-Proto $scheme;

	            client_max_body_size       10m;
	            client_body_buffer_size    128k;

	            proxy_connect_timeout      30;
	            proxy_send_timeout         30;
	            proxy_read_timeout         30;

		    proxy_buffering 		on;
	            proxy_buffer_size          32k;
	            proxy_buffers              4 32k;
	            proxy_busy_buffers_size    64k;
	            proxy_temp_file_write_size 64k;
	        }


		error_page 404 /404.html;
		location = /404.html {
			# This means, that we can't get to this location from outside - only by internal redirect
			internal;
	                root  /web/data/error-pages/;
		}

		error_page   502 503 504  /50x.html;
		location = /50x.html {
			# This means, that we can't get to this location from outside - only by internal redirect
			internal;
	                root  /web/data/error-pages/;
		}

		location /lib/data/ {
		    rewrite 	^/lib/data/(.*)$  /$1  break;
		    root	/web/data/js/;
		    expires 90d;
		}
		location /resources/ {
		    rewrite 	^/resources/(.*)$  /$1  break;
		    root	/web/data/resources/;
		    expires max;
		}

		location /graphics/ {
		    rewrite 	^/graphics/(.*)$  /$1  break;
		    root	/web/data/graphics/;
		    expires max;
		    add_header	Cache-Control "public";
		}
		location /favicon.ico {
		    root	/web/data/graphics/;
		    expires max;
		}

		location / {
		    rewrite        ^ http://$server_name$request_uri? break;
		    root /web/data/error-pages/;
		}

	}


	server {
		listen		443;
		server_name	api.phigita.net;


	        ssl                  on;
	        ssl_certificate      /web/data/ssl/nginx.cert;
	        ssl_certificate_key  /web/data/ssl/nginx.key;
	        keepalive_timeout    10 5;


		access_log off;
	#	/var/log/nginx/main_phigita_net.access.log main;
		root /web/service-phgt-0/;

	        location / {
	            proxy_pass         http://main_phigita_net;
	            proxy_redirect     off;
		    proxy_intercept_errors on;

        	    proxy_set_header   Host             $host;
	            proxy_set_header   X-Real-IP        $remote_addr;
	            proxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for;
	            proxy_set_header   X-Forwarded-Proto $scheme;

		    proxy_hide_header MIME-Version;

	            client_max_body_size       10m;
	            client_body_buffer_size    128k;

	            proxy_connect_timeout      30;
	            proxy_send_timeout         30;
	            proxy_read_timeout         30;

		    proxy_buffering 		on;
	            proxy_buffer_size          32k;
	            proxy_buffers              4 32k;
	            proxy_busy_buffers_size    64k;
	            proxy_temp_file_write_size 64k;
	        }

		error_page 404 /404.html;
		location = /404.html {
			# This means, that we can't get to this location from outside - only by internal redirect
			internal;
	                root  /web/data/error-pages/;
		}

		error_page   502 503 504  /50x.html;
		location = /50x.html {
			# This means, that we can't get to this location from outside - only by internal redirect
			internal;
	                root  /web/data/error-pages/;
		}

		location /lib/data/ {
		    rewrite 	^/lib/data/(.*)$  /$1  break;
		    root	/web/data/js/;
		    expires 90d;
		}
		location /resources/ {
		    rewrite 	^/resources/(.*)$  /$1  break;
		    root	/web/data/resources/;
		    expires max;
		}

		location /graphics/ {
		    rewrite 	^/graphics/(.*)$  /$1  break;
		    root	/web/data/graphics/;
		    expires max;
		    add_header	Cache-Control "public";
		}
		location /favicon.ico {
		    root	/web/data/graphics/;
		    expires max;
		}

	}





	server {
		listen		80;
		server_name	i.phigita.com;
		gzip off;
		location / {
	            proxy_pass         http://main_phigita_net;
	            proxy_redirect     off;
		    proxy_intercept_errors on;

        	    proxy_set_header   Host             $host:8001;
	            proxy_set_header   X-Real-IP        $remote_addr;
	            proxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for;
	            proxy_set_header   X-Forwarded-Proto $scheme;

		    proxy_hide_header MIME-Version;

	            client_max_body_size       10m;
	            client_body_buffer_size    128k;

	            proxy_connect_timeout      30;
	            proxy_send_timeout         30;
	            proxy_read_timeout         30;

		    proxy_buffering 		on;
	            proxy_buffer_size          32k;
	            proxy_buffers              4 32k;
	            proxy_busy_buffers_size    64k;
	            proxy_temp_file_write_size 64k;

		    expires 1w;
		}

		error_page 404 /404.html;
		location = /404.html {
			# This means, that we can't get to this location from outside - only by internal redirect
			internal;
	                root  /web/data/error-pages/;
		}

		error_page   502 503 504  /50x.html;
		location = /50x.html {
			# This means, that we can't get to this location from outside - only by internal redirect
			internal;
	                root  /web/data/error-pages/;
		}

	}


	server {
		listen		443;
		server_name	i.phigita.com;
		gzip off;

	        ssl                  on;
	        ssl_certificate      /web/data/ssl/nginx.cert;
	        ssl_certificate_key  /web/data/ssl/nginx.key;
	        keepalive_timeout    10 5;

		location / {
	            proxy_pass         http://main_phigita_net;
	            proxy_redirect     off;
		    proxy_intercept_errors on;

        	    proxy_set_header   Host             $host:8001;
	            proxy_set_header   X-Real-IP        $remote_addr;
	            proxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for;
	            proxy_set_header   X-Forwarded-Proto $scheme;

		    proxy_hide_header MIME-Version;

	            client_max_body_size       10m;
	            client_body_buffer_size    128k;

	            proxy_connect_timeout      30;
	            proxy_send_timeout         30;
	            proxy_read_timeout         30;

		    proxy_buffering 		on;
	            proxy_buffer_size          32k;
	            proxy_buffers              4 32k;
	            proxy_busy_buffers_size    64k;
	            proxy_temp_file_write_size 64k;

		    expires 1d;
		}

		error_page 404 /404.html;
		location = /404.html {
			# This means, that we can't get to this location from outside - only by internal redirect
			internal;
	                root  /web/data/error-pages/;
		}

		error_page   502 503 504  /50x.html;
		location = /50x.html {
			# This means, that we can't get to this location from outside - only by internal redirect
			internal;
	                root  /web/data/error-pages/;
		}

	}


}

